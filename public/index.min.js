"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}firebase.initializeApp({apiKey:"AIzaSyDszUxv08D7ypv15AfgipQ36sWbkjQUglc",authDomain:"jpco-qtodo.firebaseapp.com",projectId:"jpco-qtodo"});var db=firebase.firestore();function Title(e){var t=e.user,n=e.addTodo,o="";return o=t.isAnonymous?"anonymous":t.displayName,React.createElement("div",null,"Signed in as ",o," ",React.createElement("button",{onClick:function(){return firebase.auth().signOut()}},"Sign out"),React.createElement("h1",null,"Qdo ",React.createElement("button",{onClick:function(){return n()}},"Add item")))}db.settings({timestampsInSnapshots:!0});var hashCode=function(e){var t,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return n},swap=function(e,t,n){var o=db.batch();o.set(db.collection("todo").doc(e.id),_defineProperty({},n,t[n]),{merge:!0}),o.set(db.collection("todo").doc(t.id),_defineProperty({},n,e[n]),{merge:!0}),o.commit().catch(function(e){return console.error("error swapping todos: ",e)})};function FuncButton(e){var t=e.onClick,n=e.children;return t?React.createElement("button",{onClick:t},n):React.createElement("button",{disabled:!0},n)}function DropdownItem(e){var t=e.onClick,n=e.children;return t?React.createElement("a",{className:"notdisabled",onClick:t},n):null}function Dropdown(e){var t=e.name,n=e.children;return React.createElement("div",{className:"dropcontainer"},React.createElement("button",{className:"dropper"},t),React.createElement("div",{className:"dropdown"},n))}function TodoQueueItem(e){var t=e.todo,n=e.remove,o=e.update,r=e.move,a=void 0;return React.createElement("li",null,React.createElement(FuncButton,{onClick:function(){return n(t)}},"x"),React.createElement(Dropdown,{name:"o"},React.createElement(DropdownItem,{onClick:r.up},"Move up"),React.createElement(DropdownItem,{onClick:r.down},"Move down")),React.createElement(function(){if(!t.parent)return null;for(var e=t,n=[];e.parent;)e=e.parent,n.push(e.text);return n.reverse(),React.createElement("a",{className:"context"},n.join(" - ")," -")},null),React.createElement("input",{type:"text",className:"todoInput qTodoInput",ref:function(e){return a=e},defaultValue:t.text,onBlur:function(){return o(a.value,t)}}))}function TodoQueue(e){for(var t=e.todos,n=e.remove,o=e.update,r=t.sort(function(e,t){return t.qOrder-e.qOrder}),a=[],c=function(e){var t={up:0===e?null:function(){return swap(r[e],r[e-1],"qOrder")},down:e===r.length-1?null:function(){return swap(r[e],r[e+1],"qOrder")}};a.push(React.createElement(TodoQueueItem,{todo:r[e],key:r[e].id+"-"+hashCode(r[e].text),remove:n,update:o,move:t}))},u=0;u<r.length;u++)c(u);return React.createElement("ul",{className:"queue"},a)}function TodoTreeItem(e){var t=e.todo,n=e.add,o=e.remove,r=e.update,a=e.move,c=void 0;return React.createElement("li",null,React.createElement(FuncButton,{onClick:0!==t.children.length?null:function(){return o(t)}},"x"),React.createElement(Dropdown,{name:"o"},React.createElement(DropdownItem,{onClick:function(){return n("",t)}},"Add sub-item"),React.createElement(DropdownItem,{onClick:a.top},"Move to top"),React.createElement(DropdownItem,{onClick:a.up},"Move up"),React.createElement(DropdownItem,{onClick:a.down},"Move down"),React.createElement(DropdownItem,{onClick:a.out},"Move out"),React.createElement(DropdownItem,{onClick:a.in},"Move in")),React.createElement("input",{type:"text",className:"todoInput tTodoInput",ref:function(e){return c=e},defaultValue:t.text,onBlur:function(){return r(c.value,t)}}),React.createElement(function(e){var t=e.children;return 0===t.length?null:React.createElement(TodoTree,{todos:t,add:n,remove:o,update:r})},{children:t.children}))}function TodoTree(e){for(var t=e.todos,n=e.add,o=e.remove,r=e.update,a=function(e,t){db.collection("todo").doc(e.id).set({parent:t?t.id:null},{merge:!0}).catch(function(e){return console.error("error swapping todos: ",e)})},c=t.sort(function(e,t){return t.tOrder-e.tOrder}),u=[],d=function(e){var t={top:null,up:0===e?null:function(){return swap(c[e],c[e-1],"tOrder")},down:e===c.length-1?null:function(){return swap(c[e],c[e+1],"tOrder")},out:c[e].parent?function(){return a(c[e],c[e].parent.parent)}:null,in:0===e?null:function(){return a(c[e],c[e-1])}};u.push(React.createElement(TodoTreeItem,{todo:c[e],key:c[e].id+"-"+hashCode(c[e].text),add:n,remove:o,update:r,move:t}))},i=0;i<c.length;i++)d(i);return React.createElement("ul",null,u)}var TodoApp=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={qNext:0,tNext:0,todos:[]},db.collection("todo").where("ownerId","==",n.props.user.uid).onSnapshot(n.updateTodos.bind(n),function(e){return console.error("Could not read todo list: ",e)}),n}return _inherits(t,React.Component),_createClass(t,[{key:"updateTodos",value:function(e){var t={};e.forEach(function(e){var n=e.data();t[e.id]={id:e.id,qOrder:n.qOrder,tOrder:n.tOrder,text:n.text,parent:n.parent,children:[]}}),Object.values(t).forEach(function(e){e.parent&&t[e.parent]&&(e.parent=t[e.parent],e.parent.children.push(e))});var n=Object.values(t),o=n.reduce(function(e,t){return Math.max(e,t.qOrder)},0),r=n.reduce(function(e,t){return Math.max(e,t.tOrder)},0);this.setState({qNext:o+1,tNext:r+1,todos:n})}},{key:"handleAdd",value:function(e,t){db.collection("todo").add({text:e||"",qOrder:this.state.qNext,tOrder:this.state.tNext,ownerId:this.props.user.uid,parent:t?t.id:null}).catch(function(e){return console.error("error adding todo: ",e)})}},{key:"handleRemove",value:function(e){var t=db.batch();e.children.forEach(function(e){return t.delete(db.collection("todo").doc(e.id))}),function e(t,n){t.delete(db.collection("todo").doc(n.id)),n.parent&&1===n.parent.children.length&&e(t,n.parent)}(t,e),t.commit()}},{key:"handleUpdate",value:function(e,t){t.value!=e&&db.collection("todo").doc(t.id).set({text:e},{merge:!0}).catch(function(e){return console.error("error updating todo: ",e)})}},{key:"render",value:function(){return React.createElement("div",null,React.createElement(Title,{user:this.props.user,addTodo:this.handleAdd.bind(this)}),React.createElement(TodoQueue,{todos:this.state.todos.filter(function(e){return 0===e.children.length}),remove:this.handleRemove.bind(this),update:this.handleUpdate.bind(this)}),React.createElement("h2",null,"All"),React.createElement(TodoTree,{todos:this.state.todos.filter(function(e){return!e.parent}),add:this.handleAdd.bind(this),remove:this.handleRemove.bind(this),update:this.handleUpdate.bind(this)}))}}]),t}();window.uid=null,window.addEventListener("load",function(){firebase.auth().onAuthStateChanged(function(e){!e||null!==window.uid&&e.uid!==window.uid?e?window.location.reload():window.location.replace("login"):(window.uid=e.uid,ReactDOM.render(React.createElement(TodoApp,{user:e}),document.getElementById("container")))})});